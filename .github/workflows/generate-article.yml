name: Generate Article from Issue

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure secrets exist
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "::error::Missing OPENAI_API_KEY secret"; exit 1; fi
          if [ -z "${GEMINI_API_KEY}" ]; then
            echo "::error::Missing GEMINI_API_KEY secret"; exit 1; fi

      - name: Derive topic and params from issue
        id: parse
        shell: bash
        run: |
          TITLE='${{ github.event.issue.title }}'
          BODY='${{ github.event.issue.body }}'
          HAS_LABEL=false
          if [ "${{ github.event.action }}" = "labeled" ] && [ "${{ github.event.label.name }}" = "generate-article" ]; then
            HAS_LABEL=true
          fi
          
          # Mejorar el parsing del t√≠tulo con m√°s patrones
          shopt -s nocasematch
          TOPIC=""
          if [[ "$TITLE" =~ ^(articulo|art√≠culo|nuevo art√≠culo|nuevo articulo)[:]?[[:space:]]+(.*)$ ]]; then
            TOPIC="${BASH_REMATCH[2]}"
          elif [[ "$TITLE" =~ ^(generar|crear)[[:space:]]+(articulo|art√≠culo)[[:space:]]+(.*)$ ]]; then
            TOPIC="${BASH_REMATCH[3]}"
          elif $HAS_LABEL; then
            TOPIC=$(printf "%s" "$BODY" | head -n1 | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
          fi
          shopt -u nocasematch
          
          # Validar que tenemos un tema v√°lido
          if [ -z "$TOPIC" ] || [ "$TOPIC" = "" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extraer par√°metros del cuerpo del issue
          STYLE=$(printf "%s" "$BODY" | grep -iE '^estilo:' | head -n1 | cut -d: -f2- | xargs)
          ACCENT=$(printf "%s" "$BODY" | grep -iE '^color(:| principal:)?' | head -n1 | cut -d: -f2- | xargs)
          DETAILS=$(printf "%s" "$BODY" | grep -iE '^detalles:' | head -n1 | cut -d: -f2- | xargs)
          CATEGORY=$(printf "%s" "$BODY" | grep -iE '^categoria:' | head -n1 | cut -d: -f2- | xargs)
          [ -z "$STYLE" ] && STYLE="fotogr√°fico"
          [ -z "$ACCENT" ] && ACCENT="azul"

          echo "topic=$TOPIC" >> $GITHUB_OUTPUT
          # slug mejorado con validaci√≥n
          SLUG=$(printf "%s" "$TOPIC" | iconv -t ascii//translit 2>/dev/null | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g' | cut -c1-80)
          [ -z "$SLUG" ] && SLUG="articulo-$(date +%s)"
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "style=$STYLE" >> $GITHUB_OUTPUT
          echo "accent=$ACCENT" >> $GITHUB_OUTPUT
          echo "details=$DETAILS" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Setup Python
        if: steps.parse.outputs.skip == 'false'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        if: steps.parse.outputs.skip == 'false'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure directories exist
        if: steps.parse.outputs.skip == 'false'
        run: |
          mkdir -p content/blog
          mkdir -p public/images/blog

      - name: Generate article and images
        if: steps.parse.outputs.skip == 'false'
        id: generate
        run: |
          set -e
          python tools/generate_article.py \
            --topic "${{ steps.parse.outputs.topic }}" \
            --style "${{ steps.parse.outputs.style }}" \
            --accent "${{ steps.parse.outputs.accent }}" \
            --details "${{ steps.parse.outputs.details }}" \
            $( [ -n "${{ steps.parse.outputs.category }}" ] && echo --category "${{ steps.parse.outputs.category }}" )
          
          # Verificar que se gener√≥ el archivo
          if [ ! -f "content/blog/${{ steps.parse.outputs.slug }}.mdx" ]; then
            echo "::error::No se gener√≥ el archivo del art√≠culo"
            exit 1
          fi
          
          # Verificar que se gener√≥ una imagen
          if [ ! -d "public/images/blog/${{ steps.parse.outputs.slug }}" ]; then
            echo "::warning::No se generaron im√°genes, pero el art√≠culo se cre√≥ correctamente"
          else
            echo "‚úÖ Im√°genes generadas en public/images/blog/${{ steps.parse.outputs.slug }}/"
          fi

      - name: Commit changes
        if: steps.parse.outputs.skip == 'false' && success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # A√±adir archivos generados
          git add content/blog/ || true
          git add public/images/blog/ || true
          
          # Verificar si hay cambios
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Crear mensaje de commit seguro
          COMMIT_MSG="chore(content): generate article '${{ steps.parse.outputs.topic }}'
          
          Closes #${{ github.event.issue.number }}"
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Comment with result
        if: steps.parse.outputs.skip == 'false' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const topic = `${{ steps.parse.outputs.topic }}`;
            const slug = `${{ steps.parse.outputs.slug }}`;
            const body = `‚úÖ Art√≠culo generado exitosamente: **${topic}**
            
            üìÅ Archivos creados:
            - \`content/blog/${slug}.mdx\`
            - \`public/images/blog/${slug}/\` (im√°genes)
            
            El contenido ha sido publicado en la rama principal.`;
            await github.rest.issues.createComment({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              issue_number: context.issue.number, 
              body 
            });

      - name: Comment with error
        if: steps.parse.outputs.skip == 'false' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const topic = `${{ steps.parse.outputs.topic }}`;
            const body = `‚ùå Error al generar el art√≠culo: **${topic}**
            
            Revisa los logs del workflow para m√°s detalles.`;
            await github.rest.issues.createComment({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              issue_number: context.issue.number, 
              body 
            });

      - name: Close issue
        if: steps.parse.outputs.skip == 'false' && success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              issue_number: context.issue.number, 
              state: 'closed' 
            });
